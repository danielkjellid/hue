name: CI

on: push

env:
  COLUMNS: 120

# Projects to run CI for (update matrix.path in each job when adding new projects)
# Note: GitHub Actions doesn't support shared matrix definitions, so each job must define it

jobs:
  ruff-format:
    uses: danielkjellid/github-actions/.github/workflows/python-uv.yaml@main
    strategy:
      matrix:
        path: [hue-python, hue-django]
    with:
      working-directory: ${{ matrix.path }}
      cmd: make lint-ruff-format

  ruff-lint:
    uses: danielkjellid/github-actions/.github/workflows/python-uv.yaml@main
    strategy:
      matrix:
        path: [hue-python, hue-django]
    with:
      working-directory: ${{ matrix.path }}
      cmd: make lint-ruff

  mypy:
    uses: danielkjellid/github-actions/.github/workflows/python-uv.yaml@main
    strategy:
      matrix:
        path: [hue-python, hue-django]
    with:
      working-directory: ${{ matrix.path }}
      cmd: make lint-mypy

  lockfile-consistency:
    uses: danielkjellid/github-actions/.github/workflows/python-uv.yaml@main
    strategy:
      matrix:
        path: [hue-python, hue-django]
    with:
      working-directory: ${{ matrix.path }}
      cmd: uv lock --locked --offline

  unused-dependencies:
    uses: danielkjellid/github-actions/.github/workflows/python-uv.yaml@main
    strategy:
      matrix:
        path: [hue-python, hue-django]
    with:
      working-directory: ${{ matrix.path }}
      cmd: uv run deptry .

  python-missing-init:
    permissions: write-all
    runs-on: ubuntu-latest
    strategy:
      matrix:
        path:
          - hue-python/src/hue
          - hue-django/src/hue_django
    steps:
      - uses: actions/checkout@v3
      - name: check for missing __init__.py files
        uses: ljodal/python-actions/check-for-missing-init@feature/check-for-missing-init
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          paths: ${{ matrix.path }}

  semver-check:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        path: [hue-python, hue-django]
    steps:
      - uses: actions/checkout@v3
      - name: check for semver violations
        run: |
          cd ${{ matrix.path }}
          VERSION=$(grep -E '^version\s*=' pyproject.toml | sed -E 's/^version\s*=\s*"([^"]+)".*/\1/')
          if [ -z "$VERSION" ]; then
            echo "Error: Could not find version in pyproject.toml"
            exit 1
          fi
          echo "Found version: $VERSION"
          SEMVER_REGEX='^(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)(-((0|[1-9][0-9]*|[0-9]*[a-zA-Z-][0-9a-zA-Z-]*)(\.(0|[1-9][0-9]*|[0-9]*[a-zA-Z-][0-9a-zA-Z-]*))*))?(\+([0-9a-zA-Z-]+(\.[0-9a-zA-Z-]+)*))?$'
          if ! echo "$VERSION" | grep -qE "$SEMVER_REGEX"; then
            echo "Error: Version '$VERSION' does not match SemVer specification"
            echo "Expected format: MAJOR.MINOR.PATCH[-PRERELEASE][+BUILD]"
            exit 1
          fi
          echo "âœ“ Version '$VERSION' is valid SemVer"

  css-check:
    uses: danielkjellid/github-actions/.github/workflows/python-uv.yaml@main
    with:
      working-directory: hue-python
      cmd: make check-css

  ci-done:
    # Gather job which deploy workflow can wait on.
    name: CI done
    strategy:
      matrix:
        path: [hue-python, hue-django]
    needs:
      - ruff-format
      - ruff-lint
      - mypy
      - lockfile-consistency
      - unused-dependencies
      - python-missing-init
      - semver-check
      - css-check
    runs-on: ubuntu-latest
    steps:
      - run: echo "CI done for ${{ matrix.path }}!"
